name: ðŸš€ Release

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 2 1 * *" # Every month on the 1st at 02:00 UTC

jobs:
  build-docker:
    name: Build Docker
    strategy:
      matrix:
        include:
          - dockerfile: keycloak-cicd.Dockerfile
            runs-on: ubuntu-24.04
            platform: linux/amd64
            base-image: keycloak/keycloak:26.4
            target-tag: amd
          - dockerfile: keycloak-cicd.Dockerfile
            runs-on: ubuntu-24.04-arm
            platform: linux/arm64
            base-image: keycloak/keycloak:26.4
            target-tag: arm
    runs-on: ${{ matrix.runs-on }}
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build Docker Image
        run: |
          DOCKER_BUILDKIT=1 docker build --platform ${{ matrix.platform }} \
            -t localhost/keycloak-cicd:${{ matrix.target-tag }} \
            --build-arg BASE_IMAGE=${{ matrix.base-image }} \
            -f images/${{ matrix.dockerfile }} .
          docker save -o /tmp/keycloak-cicd.tar localhost/keycloak-cicd:${{ matrix.target-tag }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-${{ matrix.target-tag }}
          path: /tmp/keycloak-cicd.tar

  publish:
    name: Publish
    runs-on: ubuntu-24.04
    needs:
      - build-docker
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Load Docker
        run: |
          docker load -i docker-amd/keycloak-cicd.tar
          docker load -i docker-arm/keycloak-cicd.tar
          docker images

      - name: Login to Quay.io
        uses: docker/login-action@v3
        if: github.ref == 'refs/heads/main' && github.repository == 'vakamo-labs/keycloak-cicd'
        with:
          registry: quay.io
          username: vakamo+github_actions_keycloak_cicd
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Push Latest Tag to quay.io
        if: github.ref == 'refs/heads/main' && github.repository == 'vakamo-labs/keycloak-cicd'
        run: |
          # Get current date in the format yyyy-mm-dd
          DATE=$(date +"%Y-%m-%d")
          
          # Tag and push images with latest tags
          docker tag localhost/keycloak-cicd:amd quay.io/vakamo/keycloak-cicd:amd
          docker tag localhost/keycloak-cicd:arm quay.io/vakamo/keycloak-cicd:arm
          
          # Tag and push images with date tags
          docker tag localhost/keycloak-cicd:amd quay.io/vakamo/keycloak-cicd:amd-$DATE
          docker tag localhost/keycloak-cicd:arm quay.io/vakamo/keycloak-cicd:arm-$DATE
          
          # Push all tagged images
          docker push quay.io/vakamo/keycloak-cicd:amd
          docker push quay.io/vakamo/keycloak-cicd:arm
          docker push quay.io/vakamo/keycloak-cicd:amd-$DATE
          docker push quay.io/vakamo/keycloak-cicd:arm-$DATE
          
          # Create and push manifests for combined images
          docker manifest rm quay.io/vakamo/keycloak-cicd:latest || true
          docker manifest create quay.io/vakamo/keycloak-cicd:latest quay.io/vakamo/keycloak-cicd:amd quay.io/vakamo/keycloak-cicd:arm
          docker manifest push quay.io/vakamo/keycloak-cicd:latest
          
          # Create and push manifests with date tags
          docker manifest create quay.io/vakamo/keycloak-cicd:$DATE quay.io/vakamo/keycloak-cicd:amd-$DATE quay.io/vakamo/keycloak-cicd:arm-$DATE
          docker manifest push quay.io/vakamo/keycloak-cicd:$DATE

